"use strict";(globalThis.webpackChunkdocusaurus=globalThis.webpackChunkdocusaurus||[]).push([[85],{5578:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>t,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"module1-ros/python-rclpy-bridge","title":"Bridging Python Agents to ROS Controllers using rclpy","description":"Python is a popular language in robotics due to its simplicity, extensive libraries for AI/ML, and rapid prototyping capabilities. rclpy is the Python client library for ROS 2, providing a convenient and powerful way to integrate Python-based agents and algorithms with the ROS 2 ecosystem. This chapter explores how to effectively use rclpy to bridge your Python code with ROS 2 controllers and components.","source":"@site/docs/module1-ros/03-python-rclpy-bridge.md","sourceDirName":"module1-ros","slug":"/module1-ros/python-rclpy-bridge","permalink":"/ur/docs/module1-ros/python-rclpy-bridge","draft":false,"unlisted":false,"editUrl":"https://github.com/nahead/Physical-AI-Humanoid-Robotics-book/tree/main/docs/module1-ros/03-python-rclpy-bridge.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"bookSidebar","previous":{"title":"ROS 2 Nodes, Topics, and Services","permalink":"/ur/docs/module1-ros/nodes-topics-services"},"next":{"title":"Understanding URDF (Unified Robot Description Format) for Humanoids","permalink":"/ur/docs/module1-ros/urdf-humanoids"}}');var r=s(4848),i=s(8453);const t={},l="Bridging Python Agents to ROS Controllers using rclpy",a={},c=[{value:"Concepts",id:"concepts",level:2},{value:"<code>rclpy</code>: The Python ROS 2 Client Library",id:"rclpy-the-python-ros-2-client-library",level:3},{value:"Bridging Python Agents and ROS Controllers",id:"bridging-python-agents-and-ros-controllers",level:3},{value:"Working Code Examples",id:"working-code-examples",level:2},{value:"Example 1: Python Agent Publishing Joint Commands",id:"example-1-python-agent-publishing-joint-commands",level:3},{value:"<code>joint_command_publisher.py</code>",id:"joint_command_publisherpy",level:4},{value:"Example 2: Python Agent Subscribing to Sensor Data and Calling Service",id:"example-2-python-agent-subscribing-to-sensor-data-and-calling-service",level:3},{value:"<code>obstacle_avoidance_agent.py</code>",id:"obstacle_avoidance_agentpy",level:4},{value:"How to Run Examples",id:"how-to-run-examples",level:3},{value:"Temporary Stop Service Server (<code>mock_stop_server.py</code>)",id:"temporary-stop-service-server-mock_stop_serverpy",level:4},{value:"Temporary Range Sensor Publisher (<code>mock_range_sensor.py</code>)",id:"temporary-range-sensor-publisher-mock_range_sensorpy",level:4},{value:"Exercises",id:"exercises",level:2},{value:"Summary",id:"summary",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"bridging-python-agents-to-ros-controllers-using-rclpy",children:"Bridging Python Agents to ROS Controllers using rclpy"})}),"\n",(0,r.jsxs)(n.p,{children:["Python is a popular language in robotics due to its simplicity, extensive libraries for AI/ML, and rapid prototyping capabilities. ",(0,r.jsx)(n.code,{children:"rclpy"})," is the Python client library for ROS 2, providing a convenient and powerful way to integrate Python-based agents and algorithms with the ROS 2 ecosystem. This chapter explores how to effectively use ",(0,r.jsx)(n.code,{children:"rclpy"})," to bridge your Python code with ROS 2 controllers and components."]}),"\n",(0,r.jsx)(n.h2,{id:"concepts",children:"Concepts"}),"\n",(0,r.jsxs)(n.h3,{id:"rclpy-the-python-ros-2-client-library",children:[(0,r.jsx)(n.code,{children:"rclpy"}),": The Python ROS 2 Client Library"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"rclpy"})," provides Python bindings for the core ROS 2 C++ client library (",(0,r.jsx)(n.code,{children:"rclcpp"}),"). It allows Python developers to write ROS 2 nodes, publishers, subscribers, service clients, and service servers using Python. This means you can leverage Python's strengths (e.g., NumPy, SciPy, TensorFlow, PyTorch) directly within your ROS 2 applications."]}),"\n",(0,r.jsxs)(n.p,{children:["Key functionalities provided by ",(0,r.jsx)(n.code,{children:"rclpy"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Node Creation:"})," Instantiate ",(0,r.jsx)(n.code,{children:"Node"})," objects to represent your Python components in the ROS graph."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Publisher/Subscriber:"})," Create publishers to send data to topics and subscribers to receive data from topics."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Service Client/Server:"})," Implement client-server communication for request-reply patterns."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Parameters:"})," Access and manage ROS 2 parameters from your Python nodes."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Timers:"})," Schedule periodic callbacks for repetitive tasks."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Executors:"})," Manage the execution of callbacks (single-threaded or multi-threaded)."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"bridging-python-agents-and-ros-controllers",children:"Bridging Python Agents and ROS Controllers"}),"\n",(0,r.jsxs)(n.p,{children:['Many advanced robotic behaviors, especially in AI, are developed as Python "agents" (e.g., reinforcement learning agents, behavioral planners). These agents often need to interact with low-level robot controllers, which are typically implemented as ROS 2 nodes. ',(0,r.jsx)(n.code,{children:"rclpy"})," serves as the essential bridge, allowing Python agents to:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Sense:"})," Subscribe to sensor data (e.g., camera feeds, LiDAR scans) from ROS 2 topics."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Act:"})," Publish commands (e.g., joint velocities, twist commands) to ROS 2 topics or call ROS 2 services to control the robot."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Plan:"})," Communicate high-level plans or goals to other ROS 2 planning nodes."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"working-code-examples",children:"Working Code Examples"}),"\n",(0,r.jsx)(n.h3,{id:"example-1-python-agent-publishing-joint-commands",children:"Example 1: Python Agent Publishing Joint Commands"}),"\n",(0,r.jsx)(n.p,{children:"This example simulates a simple Python agent that calculates a desired joint position and publishes it to a ROS 2 topic. A ROS 2 controller (which would be a separate C++ or Python node) would then subscribe to this topic and actuate the robot."}),"\n",(0,r.jsx)(n.h4,{id:"joint_command_publisherpy",children:(0,r.jsx)(n.code,{children:"joint_command_publisher.py"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import rclpy\nfrom rclpy.node import Node\nfrom std_msgs.msg import Float64\n\nclass JointCommandPublisher(Node):\n    def __init__(self):\n        super().__init__('joint_command_publisher')\n        self.publisher_ = self.create_publisher(Float64, 'robot/joint1_position_command', 10)\n        self.timer = self.create_timer(0.1, self.timer_callback) # Publish every 100ms\n        self.desired_position = 0.0\n        self.increment = 0.01\n        self.get_logger().info('JointCommandPublisher node has been started.')\n\n    def timer_callback(self):\n        msg = Float64()\n        msg.data = self.desired_position\n        self.publisher_.publish(msg)\n        self.get_logger().info(f'Publishing joint command: {msg.data:.2f}')\n\n        # Simulate a simple agent changing the desired position\n        self.desired_position += self.increment\n        if self.desired_position > 1.0 or self.desired_position < -1.0:\n            self.increment *= -1 # Reverse direction\n            \ndef main(args=None):\n    rclpy.init(args=args)\n    node = JointCommandPublisher()\n    try:\n        rclpy.spin(node)\n    except KeyboardInterrupt:\n        node.get_logger().info('JointCommandPublisher node stopped cleanly.')\n    finally:\n        node.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"example-2-python-agent-subscribing-to-sensor-data-and-calling-service",children:"Example 2: Python Agent Subscribing to Sensor Data and Calling Service"}),"\n",(0,r.jsx)(n.p,{children:"This agent subscribes to a simulated sensor (e.g., a simple range sensor) and, if an obstacle is detected, calls a service to request a stop."}),"\n",(0,r.jsx)(n.h4,{id:"obstacle_avoidance_agentpy",children:(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent.py"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import rclpy\nfrom rclpy.node import Node\nfrom std_msgs.msg import Float32 # Simulate a range sensor reading\nfrom std_srvs.srv import Trigger # Standard service for simple actions\n\nclass ObstacleAvoidanceAgent(Node):\n    def __init__(self):\n        super().__init__('obstacle_avoidance_agent')\n        self.subscription = self.create_subscription(\n            Float32,\n            'robot/range_sensor_data',\n            self.range_sensor_callback,\n            10)\n        self.client = self.create_client(Trigger, 'robot/stop_command')\n        while not self.client.wait_for_service(timeout_sec=1.0):\n            self.get_logger().info('Stop command service not available, waiting...')\n        self.get_logger().info('ObstacleAvoidanceAgent node has been started.')\n        self.obstacle_distance_threshold = 0.5 # meters\n\n    def range_sensor_callback(self, msg):\n        current_range = msg.data\n        self.get_logger().info(f'Received range sensor data: {current_range:.2f} m')\n        \n        if current_range < self.obstacle_distance_threshold:\n            self.get_logger().warn(f'Obstacle detected at {current_range:.2f} m! Requesting stop.')\n            self.send_stop_command()\n\n    def send_stop_command(self):\n        request = Trigger.Request()\n        self.future = self.client.call_async(request)\n        self.future.add_done_callback(self.stop_command_response_callback)\n\n    def stop_command_response_callback(self, future):\n        try:\n            response = future.result()\n            if response.success:\n                self.get_logger().info('Robot stop command successful.')\n            else:\n                self.get_logger().error(f'Robot stop command failed: {response.message}')\n        except Exception as e:\n            self.get_logger().error(f'Service call failed: {e}')\n\ndef main(args=None):\n    rclpy.init(args=args)\n    node = ObstacleAvoidanceAgent()\n    try:\n        rclpy.spin(node)\n    except KeyboardInterrupt:\n        node.get_logger().info('ObstacleAvoidanceAgent node stopped cleanly.')\n    finally:\n        node.destroy_node()\n        rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,r.jsx)(n.h3,{id:"how-to-run-examples",children:"How to Run Examples"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Create/Utilize ROS 2 Workspace and Python Package:"}),"\n(Ensure your ",(0,r.jsx)(n.code,{children:"ros2_ws/src/my_ros2_package"})," is set up as described in previous chapters)."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Place Code:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Save ",(0,r.jsx)(n.code,{children:"joint_command_publisher.py"})," and ",(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent.py"})," in ",(0,r.jsx)(n.code,{children:"ros2_ws/src/my_ros2_package/my_ros2_package/"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Update ",(0,r.jsx)(n.code,{children:"setup.py"})," and ",(0,r.jsx)(n.code,{children:"package.xml"}),":"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In ",(0,r.jsx)(n.code,{children:"ros2_ws/src/my_ros2_package/setup.py"}),", add new entry points:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"entry_points={\n    'console_scripts': [\n        'joint_command_publisher = my_ros2_package.joint_command_publisher:main',\n        'obstacle_avoidance_agent = my_ros2_package.obstacle_avoidance_agent:main',\n        # ... existing entry points ...\n    ],\n},\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["In ",(0,r.jsx)(n.code,{children:"ros2_ws/src/my_ros2_package/package.xml"}),", ensure necessary dependencies (",(0,r.jsx)(n.code,{children:"std_msgs"}),", ",(0,r.jsx)(n.code,{children:"std_srvs"}),") are listed:","\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<exec_depend>rclpy</exec_depend>\n<exec_depend>std_msgs</exec_depend>\n<exec_depend>std_srvs</exec_depend>\n<exec_depend>example_interfaces</exec_depend>\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Build and Source the Workspace:"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cd ros2_ws\ncolcon build\nsource install/setup.bash\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Run ",(0,r.jsx)(n.code,{children:"joint_command_publisher"}),":"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ros2 run my_ros2_package joint_command_publisher\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will continuously publish desired joint positions."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsxs)(n.strong,{children:["Simulate ",(0,r.jsx)(n.code,{children:"robot/stop_command"})," Service and ",(0,r.jsx)(n.code,{children:"robot/range_sensor_data"})," Topic (for ",(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent"}),"):"]}),"\nYou'll need to create temporary nodes to simulate these for testing."]}),"\n",(0,r.jsxs)(n.h4,{id:"temporary-stop-service-server-mock_stop_serverpy",children:["Temporary Stop Service Server (",(0,r.jsx)(n.code,{children:"mock_stop_server.py"}),")"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import rclpy\nfrom rclpy.node import Node\nfrom std_srvs.srv import Trigger\n\nclass MockStopService(Node):\n    def __init__(self):\n        super().__init__('mock_stop_server')\n        self.srv = self.create_service(Trigger, 'robot/stop_command', self.stop_callback)\n        self.get_logger().info('Mock Stop Command service server started.')\n\n    def stop_callback(self, request, response):\n        self.get_logger().info('Received stop command!')\n        response.success = True\n        response.message = 'Robot stopped successfully.'\n        return response\n\ndef main(args=None):\n    rclpy.init(args=args)\n    node = MockStopService()\n    rclpy.spin(node)\n    node.destroy_node()\n    rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,r.jsxs)(n.h4,{id:"temporary-range-sensor-publisher-mock_range_sensorpy",children:["Temporary Range Sensor Publisher (",(0,r.jsx)(n.code,{children:"mock_range_sensor.py"}),")"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"import rclpy\nfrom rclpy.node import Node\nfrom std_msgs.msg import Float32\nimport time\n\nclass MockRangeSensor(Node):\n    def __init__(self):\n        super().__init__('mock_range_sensor')\n        self.publisher_ = self.create_publisher(Float32, 'robot/range_sensor_data', 10)\n        self.timer = self.create_timer(1.0, self.timer_callback) # Publish every 1 second\n        self.range_data = 1.0\n        self.get_logger().info('MockRangeSensor node started.')\n\n    def timer_callback(self):\n        msg = Float32()\n        # Simulate an obstacle appearing then disappearing\n        if self.get_clock().now().nanoseconds % (10 * 10**9) < (5 * 10**9): # For 5 seconds every 10 seconds\n            self.range_data = 0.3 # Simulate obstacle close\n        else:\n            self.range_data = 1.0 # No obstacle\n        \n        msg.data = self.range_data\n        self.publisher_.publish(msg)\n        self.get_logger().info(f'Publishing mock range: {msg.data:.2f} m')\n\ndef main(args=None):\n    rclpy.init(args=args)\n    node = MockRangeSensor()\n    rclpy.spin(node)\n    node.destroy_node()\n    rclpy.shutdown()\n\nif __name__ == '__main__':\n    main()\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Add Mock Nodes to ",(0,r.jsx)(n.code,{children:"setup.py"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"entry_points={\n    'console_scripts': [\n        # ... existing entry points ...\n        'mock_stop_server = my_ros2_package.mock_stop_server:main',\n        'mock_range_sensor = my_ros2_package.mock_range_sensor:main',\n    ],\n},\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Rebuild and Source:"})," ",(0,r.jsx)(n.code,{children:"colcon build"})," and ",(0,r.jsx)(n.code,{children:"source install/setup.bash"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Run ",(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Terminal 1: ",(0,r.jsx)(n.code,{children:"ros2 run my_ros2_package mock_stop_server"})]}),"\n",(0,r.jsxs)(n.li,{children:["Terminal 2: ",(0,r.jsx)(n.code,{children:"ros2 run my_ros2_package mock_range_sensor"})]}),"\n",(0,r.jsxs)(n.li,{children:["Terminal 3: ",(0,r.jsx)(n.code,{children:"ros2 run my_ros2_package obstacle_avoidance_agent"}),"\nObserve the agent reacting to the simulated range data and calling the stop service."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"exercises",children:"Exercises"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Refine Joint Command:"})," Modify ",(0,r.jsx)(n.code,{children:"joint_command_publisher.py"})," to publish commands for multiple joints, potentially simulating a simple gait for a humanoid."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Add Emergency Stop:"})," Extend ",(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent.py"}),' to implement an emergency stop logic. If an obstacle is detected within a critical distance, it should not only call the stop service but also publish a "critical_stop" message to a new topic.']}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Service with Data:"})," Create a new service that allows the Python agent to request the current robot pose (e.g., a custom ",(0,r.jsx)(n.code,{children:"GetPose"})," service)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Error Resilience:"})," Enhance the ",(0,r.jsx)(n.code,{children:"obstacle_avoidance_agent.py"})," to gracefully handle cases where the ",(0,r.jsx)(n.code,{children:"robot/stop_command"})," service is not available."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,r.jsxs)(n.p,{children:["This chapter highlighted the power of ",(0,r.jsx)(n.code,{children:"rclpy"})," in enabling seamless integration between Python-based AI agents and the ROS 2 ecosystem. You've learned how to develop Python nodes that publish control commands, subscribe to sensor data, and interact with services, forming intelligent behaviors for robots. The examples demonstrated practical bridging mechanisms, while the exercises encouraged you to build more complex and robust Python-ROS 2 interactions, laying the groundwork for developing sophisticated autonomous systems."]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>l});var o=s(6540);const r={},i=o.createContext(r);function t(e){const n=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);