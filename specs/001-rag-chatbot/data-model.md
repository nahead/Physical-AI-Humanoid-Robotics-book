# Data Model for RAG Chatbot (Updated for Supabase)

## Entities

### User (Managed by Supabase Auth)
**Description**: Represents an individual interacting with the chatbot. Supabase Auth handles core user management.
**Attributes (Supabase Auth)**:
- `id`: Unique identifier for the user (UUID, automatically generated by Supabase Auth).
- `email`: User's email address (managed by Supabase Auth).
- `created_at`: Timestamp of user creation.
- `last_sign_in_at`: Timestamp of last sign-in.
**Custom Attributes (Public `profiles` table in Supabase)**:
- `username`: (Optional) User's chosen display name.
- `preferred_language`: (Optional) User's preferred language for translation (e.g., 'en', 'ur').
**Relationships**:
- One-to-many with `Chat Session` (a user can have multiple chat sessions).

### Chat Session
**Description**: Represents a continuous conversation between a user and the chatbot. Stored in Supabase Postgres.
**Attributes**:
- `session_id`: Unique identifier for the chat session (UUID).
- `user_id`: Foreign key referencing `User.id` from Supabase Auth (NULLable for anonymous users).
- `started_at`: Timestamp when the session began.
- `last_activity_at`: Timestamp of the last message in the session.
- `title`: (Optional) A brief auto-generated or user-provided title for the session.
**Relationships**:
- Many-to-one with `User` (a chat session belongs to one user, or none).
- One-to-many with `Message` (a chat session contains multiple messages).

### Message
**Description**: Represents a single turn in a chat session, either from the user or the chatbot. Stored in Supabase Postgres.
**Attributes**:
- `message_id`: Unique identifier for the message (UUID).
- `session_id`: Foreign key referencing `Chat Session.session_id`.
- `sender`: Enum (`user`, `chatbot`).
- `content_en`: Original English text content of the message.
- `content_ur`: (Optional) Urdu translated content of the message.
- `timestamp`: Timestamp when the message was sent.
- `citations`: (Optional) JSONB array of references to `Document Chunk` IDs or metadata.
- `is_selected_text_query`: Boolean, true if this message was part of a `/chat/selected` query.
**Relationships**:
- Many-to-one with `Chat Session`.

### Document Chunk (Qdrant payload + Supabase metadata)
**Description**: A smaller, semantically meaningful segment of the Docusaurus book content, suitable for embedding and retrieval. Vector stored in Qdrant, primary metadata in Supabase for richer queries.
**Attributes (Qdrant payload & Supabase metadata)**:
- `chunk_id`: Unique identifier for the chunk (UUID).
- `document_id`: Identifier for the original Docusaurus document (e.g., file path or URL).
- `chunk_text`: The actual text content of the chunk.
- `metadata`: JSONB field containing additional information:
    - `source_file`: Original Docusaurus markdown file path.
    - `title`: Title of the section/page.
    - `heading`: Specific heading within the document.
    - `page_number`: (Optional) Page number if applicable.
    - `start_char_index`: Start character index in the original document.
    - `end_char_index`: End character index in the original document.
- `created_at`: Timestamp of chunk indexing.
**Relationships**:
- Implicit relationship with `Message` through citations.

### Vector Embedding (Qdrant specific)
**Description**: Numerical representation (vector) of a Document Chunk's semantic meaning, stored in Qdrant for similarity search.
**Attributes**:
- `id`: Qdrant internal ID, corresponding to `Document Chunk.chunk_id`.
- `vector`: The dense vector representation (generated by Gemini).
- `payload`: JSON object containing `Document Chunk.metadata` and `Document Chunk.chunk_text`.